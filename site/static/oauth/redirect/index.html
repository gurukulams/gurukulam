<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Required tro stop sec : To be removed -->
    <meta name=”robots” content=”noindex”>
    <title>Gurukulams</title>
</head>
<body>
    <script type="text/javascript">
        const params = new URLSearchParams(window.location.search)
        console.log("Welcome to OAuth {}", params.get("token"));

        fetch('/api/auth/me', {
            headers: {
                "content-type": "application/json",
                Authorization: params.get("token"),
            },
        })
            .then(response => response.json())
            .then(auth_response => {
                if (auth_response.authToken) {
                    auth_response.authToken = params.get("token");
                    auth_response.expiresIn = Date.now() + auth_response.expiresIn;
                    sessionStorage.auth = JSON.stringify(auth_response);
                    const refPage = sessionStorage.getItem("ref_page")
                    sessionStorage.removeItem("key");
                    window.location.href = refPage;
                } else {

          document.body.innerHTML = `
          <main class="col-lg-6 col-md-8 mx-auto text-center">
            <form>
              <img class="mb-4" src="/docs/5.0/assets/brand/bootstrap-logo.svg" alt="" width="72" height="57">
              <h1 class="h3 mb-3 fw-normal">Welcome to Gurukulams</h1>

              <div class="form-floating">
                <input  class="form-control" id="id" placeholder="">
                <label for="id">User Name</label>
              </div>

              <div class="form-floating">
                <input  class="form-control" id="firstName" placeholder="">
                <label for="firstName">First Name</label>
              </div>
              <div class="form-floating">
                <input  class="form-control" id="lastName" placeholder="">
                <label for="lastName">Last Name</label>
              </div>
              <div class="form-floating">
                <input  class="form-control" type="date" id="dob" placeholder="">
                <label for="dob">Date Of Birth</label>
              </div>

              <button class="w-100 btn btn-lg btn-primary" type="submit">Register</button>

            </form>
          </main>

          `;

          document.body.querySelector("img").src = auth_response.profilePicture;

          document.querySelector("form").addEventListener("submit", (event) => {
            event.token = auth_response.registrationToken;
            event.preventDefault();

    let regRequest = {
      id: document.querySelector("#id").value,
      firstName: document.querySelector("#firstName").value,
      lastName: document.querySelector("#lastName").value,
    };

    fetch("/api/auth/register", {
      method: "POST",
      headers: {
        "content-type": "application/json",
        Authorization: "Bearer " + event.token,
      },
      body: JSON.stringify(regRequest),
    })
      .then((response) => {
        if (!response.ok) {
          throw Error(response.statusText);
        }
        return response.json();
      })
      .then((auth_response) => {
        auth_response.expiresIn = Date.now() + auth_response.expiresIn;
        sessionStorage.auth = JSON.stringify(auth_response);
        const refPage = sessionStorage.getItem("ref_page")
        sessionStorage.removeItem("key");
        window.location.href = refPage;
      })
      .catch((err) => {
        document.querySelector(".d-none").classList.remove("d-none");
        console.error(err);
      });
          });


                }
                
            });

    </script>
</body>

</html>